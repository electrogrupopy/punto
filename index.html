<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro de Asistencia en Obra - Electrogrupo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px 10px 0 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-bottom: 4px solid #667eea; }
        .header h1 { color: #333; font-size: 24px; margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; }
        .main-content { background: white; padding: 30px 20px; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
        input[type="text"], select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; font-family: inherit; transition: border-color 0.3s; -webkit-appearance: none; appearance: none; }
        input[type="text"]:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; min-height: 80px; }
        .location-info { background: #f5f5f5; padding: 15px; border-radius: 6px; font-size: 13px; color: #666; margin-bottom: 15px; border-left: 4px solid #667eea; min-height: 60px; }
        .location-info.loading { color: #667eea; }
        .location-info.success { background: #e8f5e9; border-left-color: #4caf50; color: #2e7d32; }
        .location-info.error { background: #ffebee; border-left-color: #f44336; color: #c62828; }
        .photo-section { border: 2px dashed #667eea; border-radius: 6px; padding: 20px; text-align: center; margin-bottom: 20px; background: #f9f9f9; }
        .photo-section input[type="file"] { display: none; }
        .photo-upload-btn { display: inline-block; padding: 12px 24px; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; border: none; font-size: 14px; -webkit-tap-highlight-color: transparent; }
        .photo-preview { margin-top: 15px; position: relative; display: inline-block; }
        .photo-preview img { max-width: 100%; max-height: 250px; border-radius: 6px; }
        .photo-remove { position: absolute; top: -10px; right: -10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; }
        .photo-info { font-size: 11px; color: #666; margin-top: 8px; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { padding: 14px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .btn-submit { background: #4caf50; color: white; grid-column: 1 / -1; min-height: 50px; font-size: 16px; }
        .btn-submit:active { background: #388e3c; }
        .btn-report { background: #2196f3; color: white; }
        .btn-clear { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .success-message { background: #e8f5e9; border: 2px solid #4caf50; color: #2e7d32; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .success-message.active { display: block; }
        .error-message { background: #ffebee; border: 2px solid #f44336; color: #c62828; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .error-message.active { display: block; }
        .time-display { font-weight: 600; color: #667eea; margin-top: 5px; }
        .field-error { border-color: #f44336 !important; background: #fff5f5 !important; }
        .field-error-msg { color: #f44336; font-size: 12px; margin-top: 4px; display: none; }
        .field-error-msg.active { display: block; }
        
        .storage-info { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 6px; padding: 10px; margin-bottom: 15px; font-size: 12px; }
        .storage-bar { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .storage-bar-fill { height: 100%; background: #4caf50; transition: width 0.3s; }
        .storage-bar-fill.warning { background: #ff9800; }
        .storage-bar-fill.danger { background: #f44336; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.active { display: block; }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th, .report-table td { padding: 8px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .report-table th { background: #f5f5f5; }
        .report-photo { max-width: 60px; max-height: 60px; cursor: pointer; border-radius: 4px; }
        .export-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-export { padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        
        #manualLocationSection { display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px; }
        #manualLocationSection input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-top: 5px; }
        
        .photo-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .photo-modal.active { display: flex; }
        .photo-modal img { max-width: 90%; max-height: 90%; }

        #debugConsole { display: none; position: fixed; bottom: 0; left: 0; right: 0; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.95); color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; z-index: 9999; }
        #debugConsole.active { display: block; }
        .debug-toggle { position: fixed; bottom: 5px; right: 5px; background: #333; color: #0f0; border: none; padding: 5px 10px; font-size: 10px; border-radius: 4px; opacity: 0.7; z-index: 9998; }

        @media (max-width: 600px) {
            .button-group { grid-template-columns: 1fr; }
            .export-buttons { grid-template-columns: 1fr; }
            body { padding: 10px; }
            .main-content { padding: 20px 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="headerArea">
            <h1>üìç Registro de Asistencia en Obra</h1>
            <p>Electrogrupo S.A.C.I.</p>
        </div>

        <div class="main-content">
            <!-- GitHub Status Indicator -->
            <div style="background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 6px; padding: 10px; margin-bottom: 15px; font-size: 12px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div id="githubStatusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #4caf50;"></div>
                    <span id="githubStatusText">Google Sheets: Configurado ‚úì</span>
                </div>
                <span id="pendingCount" style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; display: none;">0 pendiente(s)</span>
            </div>

            <!-- Storage Info -->
            <div class="storage-info" id="storageInfo">
                <strong>üíæ Almacenamiento:</strong> <span id="storageUsed">Calculando...</span>
                <div class="storage-bar"><div class="storage-bar-fill" id="storageBar" style="width: 0%"></div></div>
                <div style="margin-top: 8px; display: flex; justify-content: space-between;">
                    <span id="storageCount">0 registros</span>
                    <button type="button" onclick="clearOldRecords()" style="background: #ff9800; color: white; border: none; padding: 3px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">üóëÔ∏è Limpiar Antiguos</button>
                </div>
            </div>

            <div style="background: #e8f5e9; border: 1px solid #81c784; border-radius: 6px; padding: 12px; margin-bottom: 15px; font-size: 12px;">
                <strong style="color: #2e7d32;">üì± Dispositivo:</strong> 
                <span id="deviceInfo" style="color: #558b2f; font-family: monospace;">---</span>
            </div>

            <div class="success-message" id="successMessage">‚úì ¬°Asistencia registrada con √©xito!</div>
            <div class="error-message" id="errorMessage"></div>

            <div id="formContainer">
                <div class="form-group">
                    <label>Fecha del Registro</label>
                    <input type="text" id="dataRegistro" readonly style="background: #f5f5f5;">
                    <div class="time-display" id="timeDisplay"></div>
                </div>

                <div class="form-group">
                    <label>Nombre del Empleado *</label>
                    <input type="text" id="nomeFuncionario" placeholder="Ingrese el nombre completo">
                    <div class="field-error-msg" id="err_nomeFuncionario">Campo requerido</div>
                </div>

                <div class="form-group">
                    <label>C√©dula de Identidad *</label>
                    <input type="text" id="cedula" placeholder="Ingrese n√∫mero de c√©dula" inputmode="numeric">
                    <div class="field-error-msg" id="err_cedula">Campo requerido</div>
                </div>

                <div class="form-group">
                    <label>Cargo/Funci√≥n *</label>
                    <select id="cargo">
                        <option value="">Seleccione una opci√≥n</option>
                        <option value="Ingeniero">Ingeniero</option>
                        <option value="T√©cnico">T√©cnico</option>
                        <option value="Plomero">Plomero</option>
                        <option value="Electricista">Electricista</option>
                        <option value="Pe√≥n">Pe√≥n</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="Operador de M√°quina">Operador de M√°quina</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <div class="field-error-msg" id="err_cargo">Seleccione una opci√≥n</div>
                </div>

                <div class="form-group">
                    <label>Cliente/Ciudad *</label>
                    <input type="text" id="obra" placeholder="Nombre del cliente o ciudad">
                    <div class="field-error-msg" id="err_obra">Campo requerido</div>
                </div>

                <div class="form-group">
                    <label>Geolocalizaci√≥n *</label>
                    <button type="button" id="captureLocation" class="photo-upload-btn">üìç Capturar Ubicaci√≥n</button>
                    <div class="location-info" id="locationInfo">Ubicaci√≥n no capturada</div>
                    <div class="field-error-msg" id="err_location">Debe capturar ubicaci√≥n</div>
                    <div id="manualLocationSection">
                        <p style="margin-bottom: 10px; color: #856404; font-size: 13px; font-weight: 600;">üìã Ingrese manualmente:</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 12px;">Latitud</label>
                                <input type="text" id="latManual" placeholder="-25.2637" inputmode="decimal">
                            </div>
                            <div>
                                <label style="font-size: 12px;">Longitud</label>
                                <input type="text" id="lngManual" placeholder="-57.5759" inputmode="decimal">
                            </div>
                        </div>
                        <button type="button" id="saveManualLoc" class="photo-upload-btn" style="width: 100%; margin-top: 10px; background: #ffc107; color: #333;">‚úì Guardar Ubicaci√≥n Manual</button>
                    </div>
                    <input type="hidden" id="latitude" value="">
                    <input type="hidden" id="longitude" value="">
                    <input type="hidden" id="accuracy" value="">
                </div>

                <div class="form-group">
                    <label>Foto de Prueba *</label>
                    <div class="photo-section" id="photoSection">
                        <input type="file" id="fotoInput" accept="image/*" capture="environment">
                        <label for="fotoInput" class="photo-upload-btn">üì∑ Capturar Foto</label>
                        <p style="margin-top: 10px; color: #999; font-size: 13px;">Toque para abrir c√°mara</p>
                        <div class="photo-preview" id="photoPreview"></div>
                        <div class="photo-info" id="photoInfo"></div>
                    </div>
                    <div class="field-error-msg" id="err_foto">Debe capturar una foto</div>
                </div>

                <div class="form-group">
                    <label>Tipo de Registro *</label>
                    <select id="tipoRegistro">
                        <option value="">Seleccione una opci√≥n</option>
                        <option value="Entrada">Entrada</option>
                        <option value="Salida">Salida</option>
                        <option value="Pausa">Pausa</option>
                        <option value="Retorno">Retorno de Pausa</option>
                    </select>
                    <div class="field-error-msg" id="err_tipoRegistro">Seleccione una opci√≥n</div>
                </div>

                <div class="form-group">
                    <label>Observaciones (opcional)</label>
                    <textarea id="observacoes" placeholder="Observaciones adicionales"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" id="btnSubmit" class="btn-submit">‚úì Registrar Asistencia</button>
                    <button type="button" id="btnReport" class="btn-report">üìä Ver Reporte</button>
                    <button type="button" id="btnClear" class="btn-clear">üîÑ Limpiar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Reporte -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Reporte del D√≠a</h2>
                <button class="modal-close" id="closeReport">&times;</button>
            </div>
            <div id="reportContent"></div>
            <div class="export-buttons">
                <button class="btn-export" id="exportPdf">üìÑ PDF</button>
                <button class="btn-export" id="exportCsv">üìã CSV</button>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <button type="button" onclick="clearAllRecords()" class="btn-danger" style="width: 100%;">üóëÔ∏è Borrar TODOS los Registros</button>
            </div>
        </div>
    </div>

    <!-- Modal Foto -->
    <div class="photo-modal" id="photoModal">
        <img id="photoModalImg" src="" alt="Foto">
    </div>

    <!-- Debug Console (oculto por defecto) -->
    <div id="debugConsole"></div>
    <button class="debug-toggle" id="debugToggle">üîß</button>

    <!-- Modal Configuraci√≥n Google Sheets -->
    <div class="modal" id="githubConfigModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuraci√≥n Google Sheets</h2>
                <button class="modal-close" onclick="document.getElementById('githubConfigModal').classList.remove('active')">&times;</button>
            </div>
            <div style="margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #4caf50;">
                <strong style="color: #2e7d32;">‚úì Google Sheets Configurado</strong>
                <p style="font-size: 12px; color: #555; margin-top: 5px;">Los registros se env√≠an autom√°ticamente a la planilla.</p>
            </div>
            <div style="display: grid; gap: 10px;">
                <button type="button" id="testGithubBtn" onclick="testGitHubConnection()" style="padding: 12px; background: #4caf50; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">üîó Probar Conexi√≥n</button>
                <button type="button" onclick="syncPendingRecords()" style="padding: 12px; background: #ff9800; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">üîÑ Sincronizar Pendientes</button>
                <a href="https://docs.google.com/spreadsheets/d/1O5e46G2obLozmqTtQOJir6iO_Hu7fE-pDY-iKy-Tmxw/edit" target="_blank" style="padding: 12px; background: #2196f3; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; text-align: center; text-decoration: none;">üìä Abrir Planilla</a>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 11px; color: #1565c0;">
                <strong>Nota:</strong> 5 toques en el t√≠tulo para abrir esta configuraci√≥n.
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DEBUG SYSTEM
        // ============================================
        var debugConsole = document.getElementById('debugConsole');
        var debugToggle = document.getElementById('debugToggle');
        var tapCount = 0;
        var tapTimer = null;
        
        document.getElementById('headerArea').onclick = function() {
            tapCount++;
            clearTimeout(tapTimer);
            tapTimer = setTimeout(function() { tapCount = 0; }, 1000);
            if (tapCount >= 5) {
                document.getElementById('githubConfigModal').classList.add('active');
                loadGitHubConfig();
                tapCount = 0;
            }
        };

        // ============================================
        // GOOGLE SHEETS CONFIGURATION
        // ============================================
        var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytkz2c_j-vDVUdyts5iqxeahKcHFN2HTvMpDj8VyF-UXGM4nbOBtXB9Xr0TnxEXj7F/exec';

        function loadGitHubConfig() {
            updateGitHubStatus();
        }

        function saveGitHubConfig() {
            alert('Configuraci√≥n de Google Sheets activa.');
        }

        function updateGitHubStatus() {
            var statusEl = document.getElementById('githubStatusIndicator');
            var statusText = document.getElementById('githubStatusText');
            statusEl.style.background = '#4caf50';
            statusText.textContent = 'Google Sheets: Configurado ‚úì';
        }

        function testGitHubConnection() {
            var testBtn = document.getElementById('testGithubBtn');
            testBtn.textContent = 'Probando...';
            testBtn.disabled = true;

            // Enviar un registro de prueba vac√≠o para verificar conexi√≥n
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: JSON.stringify({
                    id: 'TEST_' + Date.now(),
                    data: 'TEST',
                    hora: 'TEST',
                    nomeFuncionario: '** PRUEBA DE CONEXI√ìN **',
                    cedula: 'TEST',
                    cargo: 'TEST',
                    obra: 'TEST',
                    tipoRegistro: 'TEST',
                    latitude: '',
                    longitude: '',
                    deviceId: 'TEST',
                    observacoes: 'Eliminar esta fila - es solo una prueba',
                    foto: ''
                })
            })
            .then(function(response) {
                alert('‚úì Conexi√≥n exitosa con Google Sheets!');
            })
            .catch(function(e) {
                alert('‚úó Error: ' + e.message);
            })
            .finally(function() {
                testBtn.textContent = 'Probar Conexi√≥n';
                testBtn.disabled = false;
            });
        }

        // ============================================
        // GOOGLE SHEETS UPLOAD FUNCTION
        // ============================================
        function uploadToGitHub(registro) {
            return new Promise(function(resolve, reject) {
                log('Google Sheets: Enviando registro...');
                log('Online: ' + navigator.onLine);

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify(registro)
                })
                .then(function(response) {
                    log('Google Sheets: ‚úì Enviado (status: ' + response.status + ')', 'success');
                    resolve(true);
                })
                .catch(function(error) {
                    log('Google Sheets: ‚úó Error - ' + error.message, 'error');
                    reject(error);
                });
            });
        }

        function syncPendingRecords() {
            var pending = JSON.parse(localStorage.getItem('pending_github') || '[]');
            if (pending.length === 0) {
                log('GitHub: No hay registros pendientes');
                return;
            }

            log('GitHub: Sincronizando ' + pending.length + ' pendientes...');
            
            var newPending = [];
            var promises = pending.map(function(registro) {
                return uploadToGitHub(registro).catch(function() {
                    newPending.push(registro);
                    return null;
                });
            });

            Promise.all(promises).then(function() {
                localStorage.setItem('pending_github', JSON.stringify(newPending));
                updatePendingCount();
                if (newPending.length === 0) {
                    log('GitHub: ‚úì Todo sincronizado', 'success');
                } else {
                    log('GitHub: ' + newPending.length + ' a√∫n pendientes', 'warn');
                }
            });
        }

        function addToPending(registro) {
            var pending = JSON.parse(localStorage.getItem('pending_github') || '[]');
            pending.push(registro);
            localStorage.setItem('pending_github', JSON.stringify(pending));
            updatePendingCount();
        }

        function updatePendingCount() {
            var pending = JSON.parse(localStorage.getItem('pending_github') || '[]');
            var countEl = document.getElementById('pendingCount');
            if (pending.length > 0) {
                countEl.textContent = pending.length + ' pendiente(s)';
                countEl.style.display = 'inline';
            } else {
                countEl.style.display = 'none';
            }
        }
        
        debugToggle.onclick = function() {
            debugConsole.classList.toggle('active');
        };
        
        function log(msg, type) {
            type = type || 'info';
            var time = new Date().toLocaleTimeString();
            var div = document.createElement('div');
            div.style.color = type === 'error' ? '#f44' : type === 'success' ? '#0ff' : type === 'warn' ? '#ff0' : '#0f0';
            div.textContent = '[' + time + '] ' + msg;
            debugConsole.appendChild(div);
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log('[' + type + '] ' + msg);
        }

        // ============================================
        // GLOBAL STATE
        // ============================================
        var STATE = {
            fotoBase64: null,
            fotoOriginalSize: 0,
            fotoCompressedSize: 0,
            deviceId: '',
            deviceIP: 'N/A',
            isProcessing: false
        };
        
        var STORAGE_KEY = 'presencas_obra';
        var MAX_PHOTO_WIDTH = 800;  // Largura m√°xima da foto
        var PHOTO_QUALITY = 0.6;     // Qualidade JPEG (0.6 = 60%)

        // ============================================
        // INITIALIZATION
        // ============================================
        log('=== INICIANDO APP ===', 'success');
        
        // Sincronizar automaticamente quando voltar online
        window.addEventListener('online', function() {
            log('Conexi√≥n restaurada, sincronizando...', 'success');
            setTimeout(syncPendingRecords, 1000);
        });
        
        // Sincronizar pendentes ao iniciar (se tiver internet)
        if (navigator.onLine) {
            setTimeout(syncPendingRecords, 2000);
        }
        
        // Device ID
        try {
            STATE.deviceId = localStorage.getItem('deviceId');
            if (!STATE.deviceId) {
                STATE.deviceId = 'dev_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', STATE.deviceId);
            }
            document.getElementById('deviceInfo').textContent = STATE.deviceId;
            log('DeviceID: ' + STATE.deviceId);
        } catch(e) {
            STATE.deviceId = 'unknown';
            log('DeviceID error: ' + e.message, 'error');
        }

        // Update clock
        function updateClock() {
            var now = new Date();
            document.getElementById('dataRegistro').value = now.toLocaleDateString('es-ES');
            document.getElementById('timeDisplay').textContent = 'Hora: ' + now.toLocaleTimeString('es-ES');
        }
        updateClock();
        setInterval(updateClock, 1000);

        // Update storage info
        function updateStorageInfo() {
            try {
                var stored = localStorage.getItem(STORAGE_KEY);
                var size = stored ? stored.length : 0;
                var sizeKB = Math.round(size / 1024);
                var sizeMB = (size / (1024 * 1024)).toFixed(2);
                
                var registros = stored ? JSON.parse(stored) : [];
                var count = registros.length;
                
                // Estimar limite (5MB √© comum no mobile)
                var limitMB = 5;
                var percent = Math.min(100, (size / (limitMB * 1024 * 1024)) * 100);
                
                document.getElementById('storageUsed').textContent = sizeMB + ' MB de ~' + limitMB + ' MB';
                document.getElementById('storageCount').textContent = count + ' registros';
                
                var bar = document.getElementById('storageBar');
                bar.style.width = percent + '%';
                bar.className = 'storage-bar-fill';
                if (percent > 80) bar.classList.add('danger');
                else if (percent > 50) bar.classList.add('warning');
                
                log('Storage: ' + sizeMB + 'MB, ' + count + ' registros');
            } catch(e) {
                log('Error actualizando storage: ' + e.message, 'warn');
            }
        }
        updateStorageInfo();

        // ============================================
        // EVENT BINDINGS
        // ============================================
        document.getElementById('btnSubmit').onclick = function(e) {
            log('>>> CLICK en Registrar');
            e.preventDefault();
            doSubmit();
            return false;
        };

        document.getElementById('captureLocation').onclick = function(e) {
            e.preventDefault();
            captureLocation();
            return false;
        };

        document.getElementById('saveManualLoc').onclick = function(e) {
            e.preventDefault();
            saveManualLocation();
            return false;
        };

        document.getElementById('fotoInput').onchange = function(e) {
            handlePhoto(e);
        };

        document.getElementById('btnClear').onclick = function(e) {
            e.preventDefault();
            clearForm();
            return false;
        };

        document.getElementById('btnReport').onclick = function(e) {
            e.preventDefault();
            showReport();
            return false;
        };

        document.getElementById('closeReport').onclick = function() {
            document.getElementById('reportModal').classList.remove('active');
        };
        
        document.getElementById('photoModal').onclick = function() {
            document.getElementById('photoModal').classList.remove('active');
        };

        document.getElementById('exportPdf').onclick = function() { exportPDF(); };
        document.getElementById('exportCsv').onclick = function() { exportCSV(); };

        log('Eventos vinculados', 'success');

        // Inicializar status GitHub
        updateGitHubStatus();
        updatePendingCount();

        // ============================================
        // PHOTO COMPRESSION - SOLU√á√ÉO PRINCIPAL
        // ============================================
        function handlePhoto(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            STATE.fotoOriginalSize = file.size;
            log('Foto original: ' + Math.round(file.size/1024) + 'KB');
            
            document.getElementById('photoInfo').textContent = '‚è≥ Comprimiendo foto...';
            
            var reader = new FileReader();
            
            reader.onload = function(evt) {
                var img = new Image();
                
                img.onload = function() {
                    // Calcular novo tamanho mantendo propor√ß√£o
                    var width = img.width;
                    var height = img.height;
                    
                    log('Dimensiones originales: ' + width + 'x' + height);
                    
                    if (width > MAX_PHOTO_WIDTH) {
                        var ratio = MAX_PHOTO_WIDTH / width;
                        width = MAX_PHOTO_WIDTH;
                        height = Math.round(height * ratio);
                    }
                    
                    log('Dimensiones nuevas: ' + width + 'x' + height);
                    
                    // Criar canvas e comprimir
                    var canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Converter para JPEG com qualidade reduzida
                    STATE.fotoBase64 = canvas.toDataURL('image/jpeg', PHOTO_QUALITY);
                    STATE.fotoCompressedSize = STATE.fotoBase64.length;
                    
                    var originalKB = Math.round(STATE.fotoOriginalSize / 1024);
                    var compressedKB = Math.round(STATE.fotoCompressedSize / 1024);
                    var reduction = Math.round((1 - STATE.fotoCompressedSize / STATE.fotoOriginalSize) * 100);
                    
                    log('Foto comprimida: ' + compressedKB + 'KB (reducci√≥n: ' + reduction + '%)', 'success');
                    
                    // Mostrar preview
                    var preview = document.getElementById('photoPreview');
                    preview.innerHTML = '<div style="position:relative;display:inline-block;">' +
                        '<img src="' + STATE.fotoBase64 + '" style="max-width:100%;max-height:200px;border-radius:6px;">' +
                        '<button type="button" class="photo-remove" onclick="removePhoto()">&times;</button>' +
                        '</div>';
                    
                    document.getElementById('photoInfo').innerHTML = 
                        '‚úì Original: ' + originalKB + 'KB ‚Üí Comprimida: ' + compressedKB + 'KB ' +
                        '<span style="color: #4caf50;">(-' + reduction + '%)</span>';
                    
                    document.getElementById('err_foto').classList.remove('active');
                    document.getElementById('photoSection').style.borderColor = '#4caf50';
                };
                
                img.onerror = function() {
                    log('Error cargando imagen', 'error');
                    showError('Error al procesar la foto');
                };
                
                img.src = evt.target.result;
            };
            
            reader.onerror = function() {
                log('Error leyendo archivo', 'error');
                showError('Error al leer la foto');
            };
            
            reader.readAsDataURL(file);
        }
        
        window.removePhoto = function() {
            STATE.fotoBase64 = null;
            document.getElementById('fotoInput').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photoInfo').textContent = '';
            document.getElementById('photoSection').style.borderColor = '#667eea';
        };

        // ============================================
        // SUBMIT FUNCTION
        // ============================================
        function doSubmit() {
            log('--- doSubmit() ---', 'success');
            
            if (STATE.isProcessing) {
                log('Ya procesando', 'warn');
                return;
            }
            
            STATE.isProcessing = true;
            var btn = document.getElementById('btnSubmit');
            btn.textContent = '‚è≥ Procesando...';
            btn.style.background = '#ff9800';
            
            clearErrors();
            
            // Obtener valores
            var nomeFuncionario = document.getElementById('nomeFuncionario').value.trim();
            var cedula = document.getElementById('cedula').value.trim();
            var cargo = document.getElementById('cargo').value;
            var obra = document.getElementById('obra').value.trim();
            var tipoRegistro = document.getElementById('tipoRegistro').value;
            var latitude = document.getElementById('latitude').value;
            var longitude = document.getElementById('longitude').value;
            var accuracy = document.getElementById('accuracy').value;
            var observacoes = document.getElementById('observacoes').value.trim();
            var dataRegistro = document.getElementById('dataRegistro').value;
            
            log('Foto: ' + (STATE.fotoBase64 ? Math.round(STATE.fotoBase64.length/1024) + 'KB' : 'NO'));
            
            // Validar
            var errors = [];
            if (!nomeFuncionario) { errors.push('nombre'); showFieldError('nomeFuncionario'); }
            if (!cedula) { errors.push('cedula'); showFieldError('cedula'); }
            if (!cargo) { errors.push('cargo'); showFieldError('cargo'); }
            if (!obra) { errors.push('obra'); showFieldError('obra'); }
            if (!tipoRegistro) { errors.push('tipo'); showFieldError('tipoRegistro'); }
            if (!latitude) { errors.push('ubicaci√≥n'); document.getElementById('err_location').classList.add('active'); }
            if (!STATE.fotoBase64) { 
                errors.push('foto'); 
                document.getElementById('err_foto').classList.add('active');
                document.getElementById('photoSection').style.borderColor = '#f44336';
            }
            
            if (errors.length > 0) {
                log('Validaci√≥n fall√≥: ' + errors.join(', '), 'error');
                showError('Complete: ' + errors.join(', '));
                resetButton();
                return;
            }
            
            // Verificar fecha
            var hoje = new Date().toLocaleDateString('es-ES');
            if (dataRegistro !== hoje) {
                showError('Solo fecha actual permitida');
                resetButton();
                return;
            }
            
            // Criar registro
            var registro = {
                id: Date.now(),
                data: dataRegistro,
                hora: new Date().toLocaleTimeString('es-ES'),
                nomeFuncionario: nomeFuncionario,
                cedula: cedula,
                cargo: cargo,
                obra: obra,
                latitude: latitude,
                longitude: longitude,
                accuracy: accuracy,
                tipoRegistro: tipoRegistro,
                observacoes: observacoes,
                foto: STATE.fotoBase64,
                deviceId: STATE.deviceId
            };
            
            // Guardar
            try {
                var registros = [];
                var stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    registros = JSON.parse(stored);
                }
                
                registros.push(registro);
                
                var jsonStr = JSON.stringify(registros);
                log('Guardando: ' + Math.round(jsonStr.length/1024) + 'KB');
                
                localStorage.setItem(STORAGE_KEY, jsonStr);
                
                log('=== GUARDADO OK ===', 'success');
                
                document.getElementById('successMessage').classList.add('active');
                document.getElementById('errorMessage').classList.remove('active');
                
                updateStorageInfo();
                
                // Upload para Google Sheets
                if (GOOGLE_SCRIPT_URL) {
                    uploadToGitHub(registro)
                        .then(function() {
                            log('Registro sincronizado con Google Sheets', 'success');
                        })
                        .catch(function(err) {
                            log('Google Sheets fall√≥, agregado a pendientes', 'warn');
                            addToPending(registro);
                        });
                }
                
                setTimeout(function() {
                    clearForm();
                    document.getElementById('successMessage').classList.remove('active');
                }, 2000);
                
            } catch(e) {
                log('ERROR: ' + e.message, 'error');
                
                if (e.name === 'QuotaExceededError' || e.message.indexOf('quota') >= 0) {
                    showError('Almacenamiento lleno. Borre registros antiguos.');
                    
                    // Ofrecer limpieza autom√°tica
                    if (confirm('¬øDesea borrar registros de d√≠as anteriores para liberar espacio?')) {
                        clearOldRecords();
                        // Intentar guardar de nuevo
                        try {
                            var registros2 = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                            registros2.push(registro);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(registros2));
                            log('Guardado despu√©s de limpieza', 'success');
                            document.getElementById('successMessage').classList.add('active');
                            updateStorageInfo();
                            setTimeout(function() {
                                clearForm();
                                document.getElementById('successMessage').classList.remove('active');
                            }, 2000);
                        } catch(e2) {
                            showError('A√∫n sin espacio. Borre todos los registros.');
                        }
                    }
                } else {
                    showError('Error: ' + e.message);
                }
            }
            
            resetButton();
            
            function resetButton() {
                STATE.isProcessing = false;
                btn.textContent = '‚úì Registrar Asistencia';
                btn.style.background = '#4caf50';
            }
        }

        // ============================================
        // STORAGE MANAGEMENT
        // ============================================
        window.clearOldRecords = function() {
            try {
                var hoje = new Date().toLocaleDateString('es-ES');
                var stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return;
                
                var registros = JSON.parse(stored);
                var countBefore = registros.length;
                
                // Manter apenas registros de hoje
                registros = registros.filter(function(r) { return r.data === hoje; });
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
                
                var deleted = countBefore - registros.length;
                log('Borrados ' + deleted + ' registros antiguos', 'success');
                alert('Se borraron ' + deleted + ' registros de d√≠as anteriores.');
                
                updateStorageInfo();
            } catch(e) {
                log('Error limpiando: ' + e.message, 'error');
            }
        };
        
        window.clearAllRecords = function() {
            if (confirm('¬øBORRAR TODOS los registros? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('¬øEst√° SEGURO? Se perder√°n todos los datos.')) {
                    localStorage.removeItem(STORAGE_KEY);
                    log('Todos los registros borrados', 'warn');
                    alert('Todos los registros han sido borrados.');
                    updateStorageInfo();
                    document.getElementById('reportModal').classList.remove('active');
                }
            }
        };

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function showFieldError(fieldId) {
            var field = document.getElementById(fieldId);
            var err = document.getElementById('err_' + fieldId);
            if (field) field.classList.add('field-error');
            if (err) err.classList.add('active');
        }
        
        function clearErrors() {
            var fields = document.querySelectorAll('.field-error');
            for (var i = 0; i < fields.length; i++) fields[i].classList.remove('field-error');
            var errs = document.querySelectorAll('.field-error-msg');
            for (var i = 0; i < errs.length; i++) errs[i].classList.remove('active');
            document.getElementById('photoSection').style.borderColor = '#667eea';
        }
        
        function showError(msg) {
            var el = document.getElementById('errorMessage');
            el.textContent = '‚ùå ' + msg;
            el.classList.add('active');
        }
        
        function clearForm() {
            document.getElementById('nomeFuncionario').value = '';
            document.getElementById('cedula').value = '';
            document.getElementById('cargo').value = '';
            document.getElementById('obra').value = '';
            document.getElementById('tipoRegistro').value = '';
            document.getElementById('observacoes').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('accuracy').value = '';
            document.getElementById('latManual').value = '';
            document.getElementById('lngManual').value = '';
            
            STATE.fotoBase64 = null;
            document.getElementById('fotoInput').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photoInfo').textContent = '';
            document.getElementById('photoSection').style.borderColor = '#667eea';
            
            var locInfo = document.getElementById('locationInfo');
            locInfo.className = 'location-info';
            locInfo.textContent = 'Ubicaci√≥n no capturada';
            document.getElementById('manualLocationSection').style.display = 'none';
            
            clearErrors();
            document.getElementById('errorMessage').classList.remove('active');
            updateClock();
        }

        // ============================================
        // GEOLOCATION
        // ============================================
        function captureLocation() {
            var locInfo = document.getElementById('locationInfo');
            locInfo.className = 'location-info loading';
            locInfo.textContent = 'üîÑ Obteniendo ubicaci√≥n...';
            
            if (!navigator.geolocation) {
                showLocationError();
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    setLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy || 50, 'GPS');
                },
                function(err) {
                    log('GPS error: ' + err.message, 'warn');
                    // Tentar IP
                    fetch('https://ipapi.co/json/')
                        .then(function(r) { return r.json(); })
                        .then(function(d) {
                            if (d.latitude && d.longitude) {
                                setLocation(d.latitude, d.longitude, 5000, 'IP');
                            } else {
                                showLocationError();
                            }
                        })
                        .catch(function() { showLocationError(); });
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }
        
        function setLocation(lat, lng, acc, method) {
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            document.getElementById('accuracy').value = acc;
            
            var locInfo = document.getElementById('locationInfo');
            locInfo.className = 'location-info success';
            locInfo.innerHTML = '<strong>' + (method === 'GPS' ? '‚úì GPS' : 'üì° IP') + '</strong><br>' +
                'Lat: ' + parseFloat(lat).toFixed(6) + ', Lng: ' + parseFloat(lng).toFixed(6) + '<br>' +
                '<a href="https://maps.google.com/?q=' + lat + ',' + lng + '" target="_blank" style="color:#667eea;font-size:12px;">üìç Ver mapa</a>';
            
            document.getElementById('manualLocationSection').style.display = 'none';
            document.getElementById('err_location').classList.remove('active');
            log('Ubicaci√≥n: ' + lat + ', ' + lng + ' (' + method + ')', 'success');
        }
        
        function showLocationError() {
            var locInfo = document.getElementById('locationInfo');
            locInfo.className = 'location-info error';
            locInfo.textContent = '‚ùå No se pudo obtener. Use opci√≥n manual.';
            document.getElementById('manualLocationSection').style.display = 'block';
        }
        
        function saveManualLocation() {
            var lat = parseFloat(document.getElementById('latManual').value);
            var lng = parseFloat(document.getElementById('lngManual').value);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showError('Coordenadas inv√°lidas');
                return;
            }
            
            setLocation(lat, lng, 0, 'Manual');
        }

        // ============================================
        // REPORT
        // ============================================
        var reportData = [];
        
        function showReport() {
            var hoje = new Date().toLocaleDateString('es-ES');
            var registros = [];
            
            try {
                var stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    registros = JSON.parse(stored);
                    registros = registros.filter(function(r) { return r.data === hoje; });
                }
            } catch(e) {}
            
            reportData = registros;
            var content = document.getElementById('reportContent');
            
            if (registros.length === 0) {
                content.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">üì≠ No hay registros para hoy</p>';
            } else {
                var html = '<p style="margin-bottom:15px;"><strong>Fecha:</strong> ' + hoje + ' | <strong>Total:</strong> ' + registros.length + '</p>';
                html += '<div style="overflow-x:auto;"><table class="report-table"><thead><tr><th>Hora</th><th>Nombre</th><th>Tipo</th><th>Obra</th><th>Foto</th></tr></thead><tbody>';
                
                for (var i = 0; i < registros.length; i++) {
                    var r = registros[i];
                    html += '<tr><td>' + r.hora + '</td><td>' + r.nomeFuncionario + '</td><td>' + r.tipoRegistro + '</td><td>' + r.obra + '</td>' +
                        '<td>' + (r.foto ? '<img src="' + r.foto + '" class="report-photo" onclick="openPhoto(' + i + ')">' : '-') + '</td></tr>';
                }
                
                html += '</tbody></table></div>';
                content.innerHTML = html;
            }
            
            document.getElementById('reportModal').classList.add('active');
        }
        
        window.openPhoto = function(i) {
            if (reportData[i] && reportData[i].foto) {
                document.getElementById('photoModalImg').src = reportData[i].foto;
                document.getElementById('photoModal').classList.add('active');
            }
        };
        
        function exportPDF() {
            if (!reportData.length) { alert('No hay datos'); return; }
            var hoje = new Date().toLocaleDateString('es-ES');
            var win = window.open('', '_blank');
            if (!win) { alert('Permita ventanas emergentes'); return; }
            
            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Reporte</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th{background:#667eea;color:white;padding:8px}td{border:1px solid #ddd;padding:8px}.detail{margin:20px 0;padding:15px;border:1px solid #ddd;page-break-inside:avoid}img{max-width:200px}</style></head><body>';
            html += '<h2 style="text-align:center">REPORTE DE ASISTENCIA - ' + hoje + '</h2><p>Total: ' + reportData.length + '</p>';
            html += '<table><tr><th>Hora</th><th>Nombre</th><th>C√©dula</th><th>Cargo</th><th>Tipo</th><th>Obra</th><th>Dispositivo</th><th>Observaciones</th></tr>';
            for (var i = 0; i < reportData.length; i++) {
                var r = reportData[i];
                html += '<tr><td>' + r.hora + '</td><td>' + r.nomeFuncionario + '</td><td>' + r.cedula + '</td><td>' + r.cargo + '</td><td>' + r.tipoRegistro + '</td><td>' + r.obra + '</td><td style="font-size:9px;font-family:monospace;">' + (r.deviceId || '-') + '</td><td style="font-size:10px;">' + (r.observacoes || '-') + '</td></tr>';
            }
            html += '</table><h3>Fotos</h3>';
            for (var i = 0; i < reportData.length; i++) {
                var r = reportData[i];
                html += '<div class="detail"><strong>' + r.nomeFuncionario + ' - ' + r.hora + '</strong><br><span style="font-size:10px;color:#666;">Dispositivo: ' + (r.deviceId || '-') + '</span><br>' + (r.foto ? '<img src="' + r.foto + '">' : '') + (r.observacoes ? '<br><em style="font-size:11px;color:#555;">Obs: ' + r.observacoes + '</em>' : '') + '</div>';
            }
            html += '</body></html>';
            win.document.write(html);
            win.document.close();
            setTimeout(function() { win.print(); }, 500);
        }
        
        function exportCSV() {
            if (!reportData.length) { alert('No hay datos'); return; }
            var csv = 'Fecha,Hora,Nombre,Cedula,Cargo,Tipo,Obra,Lat,Lng,Dispositivo,Observaciones\n';
            for (var i = 0; i < reportData.length; i++) {
                var r = reportData[i];
                var obs = (r.observacoes || '').replace(/"/g, '""');
                csv += '"' + r.data + '","' + r.hora + '","' + r.nomeFuncionario + '","' + r.cedula + '","' + r.cargo + '","' + r.tipoRegistro + '","' + r.obra + '","' + r.latitude + '","' + r.longitude + '","' + (r.deviceId || '') + '","' + obs + '"\n';
            }
            var blob = new Blob([csv], {type:'text/csv'});
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'reporte_' + new Date().toLocaleDateString('es-ES').replace(/\//g,'-') + '.csv';
            link.click();
        }

        log('=== APP LISTA ===', 'success');
    </script>
</body>
</html>
