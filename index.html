<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Asistencia en Obra - Electrogrupo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-bottom: 4px solid #667eea;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .main-content {
            background: white;
            padding: 30px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .location-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .location-info.loading {
            color: #667eea;
        }

        .location-info.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
            color: #2e7d32;
        }

        .location-info.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }

        .photo-section {
            border: 2px dashed #667eea;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background: #f9f9f9;
            transition: all 0.3s;
        }

        .photo-section:hover {
            border-color: #764ba2;
            background: #f5f5f5;
        }

        .photo-section input[type="file"] {
            display: none;
        }

        .photo-upload-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .photo-upload-btn:hover {
            background: #764ba2;
        }

        .photo-preview {
            margin-top: 15px;
            position: relative;
            display: inline-block;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .photo-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .photo-remove:hover {
            background: #d32f2f;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit {
            background: #4caf50;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-submit:hover {
            background: #388e3c;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-report {
            background: #2196f3;
            color: white;
        }

        .btn-report:hover {
            background: #1976d2;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.3);
        }

        .btn-clear {
            background: #ff9800;
            color: white;
        }

        .btn-clear:hover {
            background: #f57c00;
            box-shadow: 0 2px 10px rgba(255, 152, 0, 0.3);
        }

        .date-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 13px;
            display: none;
        }

        .date-warning.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #333;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .report-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        .report-table tr:hover {
            background: #f9f9f9;
        }

        .report-photo {
            max-width: 100px;
            max-height: 100px;
            cursor: pointer;
            border-radius: 4px;
            transition: transform 0.3s;
        }

        .report-photo:hover {
            transform: scale(1.05);
        }

        .photo-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .photo-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-export {
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-export:hover {
            background: #764ba2;
        }

        .btn-whatsapp {
            background: #25d366;
        }

        .btn-whatsapp:hover {
            background: #20ba5a;
        }

        .empty-report {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-report p {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .success-message {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .error-message {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .time-display {
            font-weight: 600;
            color: #667eea;
            margin-top: 5px;
        }

        .phone-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .phone-input-group input {
            flex: 1;
            margin-bottom: 0;
        }

        .phone-input-group button {
            padding: 12px 20px;
            background: #25d366;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .phone-input-group button:hover {
            background: #20ba5a;
        }

        #manualLocationSection input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            margin-top: 3px;
        }

        #manualLocationSection input:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2);
        }

        #locationInfo {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-status-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        .location-status-icon.success {
            animation: none;
            color: #4caf50;
        }

        .location-status-icon.error {
            animation: none;
            color: #f44336;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 20px;
            }

            .main-content {
                padding: 20px 15px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .export-buttons {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 20% auto;
            }

            .phone-input-group {
                flex-direction: column;
            }

            .phone-input-group button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìç Registro de Asistencia en Obra</h1>
            <p>Electrogrupo S.A.C.I.</p>
        </div>

        <div class="main-content">
            <!-- ‚úÖ NUEVO: Informaci√≥n del Dispositivo -->
            <div style="background: #e8f5e9; border: 1px solid #81c784; border-radius: 6px; padding: 12px; margin-bottom: 15px; font-size: 12px;">
                <strong style="color: #2e7d32;">üì± Dispositivo:</strong> 
                <span id="deviceInfo" style="color: #558b2f; font-family: monospace; word-break: break-all;">Cargando...</span>
                <br>
                <strong style="color: #2e7d32;">üåê IP:</strong> 
                <span id="ipInfo" style="color: #558b2f; font-family: monospace;">Cargando...</span>
            </div>

            <div class="success-message" id="successMessage">
                ‚úì ¬°Asistencia registrada con √©xito!
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="date-warning" id="dateWarning">
                ‚ö†Ô∏è Est√° intentando registrar una asistencia en una fecha anterior. Solo se permiten registros del d√≠a actual.
            </div>

            <div id="locationHelpSection" style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 6px; padding: 15px; margin-bottom: 20px; display: none;">
                <p style="margin: 0 0 15px 0; color: #1565c0; font-weight: 600; font-size: 14px;">üîß SOLUCIONAR PROBLEMA DE GPS</p>
                
                <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 12px; border-left: 4px solid #2196f3;">
                    <p style="margin: 0 0 8px 0; font-weight: 600; color: #0d47a1; font-size: 13px;">‚úì Opci√≥n 1: Reintentar con mejor se√±al</p>
                    <ul style="margin: 5px 0 0 20px; font-size: 12px; color: #333; line-height: 1.6;">
                        <li>Aseg√∫rese de estar en √ÅREA ABIERTA (sin techo)</li>
                        <li>Espere cerca de una ventana</li>
                        <li>Intente en un momento diferente</li>
                        <li>Click nuevamente en "üìç Capturar Ubicaci√≥n"</li>
                    </ul>
                </div>
                
                <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 12px; border-left: 4px solid #ff9800;">
                    <p style="margin: 0 0 8px 0; font-weight: 600; color: #e65100; font-size: 13px;">‚úì Opci√≥n 2: Verificar permisos del navegador</p>
                    <ul style="margin: 5px 0 0 20px; font-size: 12px; color: #333; line-height: 1.6;">
                        <li><strong>Chrome Android:</strong> Men√∫ ‚ãÆ ‚Üí Configuraci√≥n ‚Üí Privacidad ‚Üí Permisos ‚Üí Ubicaci√≥n</li>
                        <li><strong>Chrome Desktop:</strong> Click en üîí ‚Üí Ubicaci√≥n ‚Üí Permitir</li>
                        <li><strong>Safari iPhone:</strong> Configuraci√≥n ‚Üí Privacidad ‚Üí Ubicaci√≥n ‚Üí Safari (Mientras usas la app)</li>
                    </ul>
                </div>
                
                <div style="background: white; padding: 12px; border-radius: 4px; border-left: 4px solid #4caf50;">
                    <p style="margin: 0 0 8px 0; font-weight: 600; color: #2e7d32; font-size: 13px;">‚úì Opci√≥n 3: Usar entrada manual (m√°s f√°cil)</p>
                    <ul style="margin: 5px 0 0 20px; font-size: 12px; color: #333; line-height: 1.6;">
                        <li>Abra <strong>Google Maps</strong></li>
                        <li>Busque o ubique su obra</li>
                        <li><strong>Click derecho</strong> sobre el punto</li>
                        <li>Copie las coordenadas</li>
                        <li>Pegue en los campos de Latitud y Longitud abajo</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-top: 12px; border-left: 4px solid #ffc107; font-size: 12px; color: #856404;">
                    <strong>üí° Consejo:</strong> Si Chrome est√° permitiendo ubicaci√≥n pero a√∫n no funciona, intente en navegador Firefox o Safari. A veces otros navegadores detectan GPS mejor.
                </div>
            </div>

            <form id="presencaForm">
                <!-- Fecha y Hora -->
                <div class="form-group">
                    <label>Fecha del Registro</label>
                    <input type="text" id="dataRegistro" readonly style="background: #f5f5f5; cursor: not-allowed;">
                    <div class="time-display" id="timeDisplay"></div>
                </div>

                <!-- Nombre del Empleado -->
                <div class="form-group">
                    <label for="nomeFuncionario">Nombre del Empleado *</label>
                    <input type="text" id="nomeFuncionario" placeholder="Ingrese el nombre completo" required>
                </div>

                <!-- C√©dula de Identidad -->
                <div class="form-group">
                    <label for="cedula">C√©dula de Identidad *</label>
                    <input type="text" id="cedula" placeholder="Ingrese n√∫mero de c√©dula" required>
                </div>

                <!-- Cargo/Funci√≥n -->
                <div class="form-group">
                    <label for="cargo">Cargo/Funci√≥n *</label>
                    <select id="cargo" required>
                        <option value="">Seleccione una opci√≥n</option>
                        <option value="Ingeniero">Ingeniero</option>
                        <option value="T√©cnico">T√©cnico</option>
                        <option value="Plomero">Plomero</option>
                        <option value="Electricista">Electricista</option>
                        <option value="Pe√≥n">Pe√≥n</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="Operador de M√°quina">Operador de M√°quina</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <!-- Cliente/Ciudad -->
                <div class="form-group">
                    <label for="obra">Cliente/Ciudad *</label>
                    <input type="text" id="obra" placeholder="Nombre del cliente o ciudad donde se realiza la obra" required>
                </div>

                <!-- Geolocalizaci√≥n -->
                <div class="form-group">
                    <label>Geolocalizaci√≥n *</label>
                    <button type="button" id="captureLocation" class="photo-upload-btn">üìç Capturar Ubicaci√≥n</button>
                    <div class="location-info" id="locationInfo">
                        Ubicaci√≥n no capturada
                    </div>
                    <div id="manualLocationSection" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                        <p style="margin-bottom: 10px; color: #856404; font-size: 13px; font-weight: 600;">üìã Ingrese manualmente la ubicaci√≥n</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px; margin-bottom: 5px; display: block;">Latitud</label>
                                <input type="text" id="latitudeManual" placeholder="-25.2637" style="padding: 8px; font-size: 12px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; margin-bottom: 5px; display: block;">Longitud</label>
                                <input type="text" id="longitudeManual" placeholder="-57.5759" style="padding: 8px; font-size: 12px;">
                            </div>
                        </div>
                        <button type="button" id="saveManualLocation" class="photo-upload-btn" style="width: 100%; padding: 10px; font-size: 13px; background: #ffc107; color: #333;">‚úì Guardar Ubicaci√≥n Manual</button>
                    </div>
                    <input type="hidden" id="latitude">
                    <input type="hidden" id="longitude">
                    <input type="hidden" id="accuracy">
                </div>

                <!-- Foto -->
                <div class="form-group">
                    <label>Foto de Prueba *</label>
                    <div class="photo-section">
                        <input type="file" id="fotoInput" accept="image/*" capture="environment">
                        <label for="fotoInput" class="photo-upload-btn">üì∑ Capturar Foto</label>
                        <p style="margin-top: 10px; color: #999; font-size: 13px;">o toque para usar c√°mara</p>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                </div>

                <!-- Hora de Entrada/Salida -->
                <div class="form-group">
                    <label for="tipoRegistro">Tipo de Registro *</label>
                    <select id="tipoRegistro" required>
                        <option value="">Seleccione una opci√≥n</option>
                        <option value="Entrada">Entrada</option>
                        <option value="Salida">Salida</option>
                        <option value="Pausa">Pausa</option>
                        <option value="Retorno">Retorno de Pausa</option>
                    </select>
                </div>

                <!-- Observaciones -->
                <div class="form-group">
                    <label for="observacoes">Observaciones</label>
                    <textarea id="observacoes" placeholder="Ingrese observaciones adicionales (opcional)"></textarea>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="button-group">
                    <button type="submit" class="btn-submit" id="submitBtn">‚úì Registrar Asistencia</button>
                    <button type="button" class="btn-report" id="viewReportBtn">üìä Ver Reporte del D√≠a</button>
                    <button type="button" class="btn-clear" id="clearBtn">üîÑ Limpiar Formulario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Reporte -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Reporte del D√≠a</h2>
                <button class="modal-close" id="closeReportBtn">&times;</button>
            </div>
            <div id="reportContent"></div>
            <div class="export-buttons">
                <button class="btn-export" id="exportPdfBtn">üìÑ Descargar PDF</button>
                <button class="btn-export" id="exportCsvBtn">üìã Descargar CSV</button>
                <button class="btn-export btn-whatsapp" id="exportWhatsappBtn">üí¨ Enviar por WhatsApp</button>
            </div>
        </div>
    </div>

    <!-- Modal para WhatsApp -->
    <div class="modal" id="whatsappModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí¨ Enviar por WhatsApp</h2>
                <button class="modal-close" id="closeWhatsappBtn">&times;</button>
            </div>
            <div class="form-group">
                <label for="whatsappPhone">N√∫mero de Tel√©fono (con c√≥digo de pa√≠s) *</label>
                <input type="text" id="whatsappPhone" placeholder="+595991234567" required>
                <small style="color: #666; margin-top: 5px; display: block;">Ejemplo: +595 (Paraguay)</small>
            </div>
            <div class="phone-input-group">
                <button type="button" id="sendWhatsappPdfBtn" class="phone-input-group button" style="background: #25d366; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üì§ Enviar PDF por WhatsApp</button>
            </div>
            <div id="whatsappMessage" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-left: 4px solid #2196f3; display: none; border-radius: 6px;"></div>
        </div>
    </div>

    <!-- Modal para visualizar foto ampliada -->
    <div class="photo-modal" id="photoModal">
        <img id="photoModalImage" src="" alt="Foto ampliada">
    </div>

    <script>
        // Inicializaci√≥n
        const form = document.getElementById('presencaForm');
        const dataRegistroInput = document.getElementById('dataRegistro');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const dateWarning = document.getElementById('dateWarning');
        const locationInfo = document.getElementById('locationInfo');
        const captureLocationBtn = document.getElementById('captureLocation');
        const fotoInput = document.getElementById('fotoInput');
        const photoPreview = document.getElementById('photoPreview');
        const submitBtn = document.getElementById('submitBtn');
        const viewReportBtn = document.getElementById('viewReportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const reportModal = document.getElementById('reportModal');
        const closeReportBtn = document.getElementById('closeReportBtn');
        const reportContent = document.getElementById('reportContent');
        const photoModal = document.getElementById('photoModal');
        const photoModalImage = document.getElementById('photoModalImage');
        const whatsappModal = document.getElementById('whatsappModal');
        const closeWhatsappBtn = document.getElementById('closeWhatsappBtn');
        const exportWhatsappBtn = document.getElementById('exportWhatsappBtn');
        const sendWhatsappPdfBtn = document.getElementById('sendWhatsappPdfBtn');
        const whatsappPhoneInput = document.getElementById('whatsappPhone');
        const whatsappMessage = document.getElementById('whatsappMessage');

        let fotoBase64 = null;
        let reportDataGlobal = [];
        const STORAGE_KEY = 'presencas_obra';

        // ‚úÖ NOVO: Obtener Device ID (genera basado en navegador y hardware)
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            
            if (!deviceId) {
                // Generar ID √∫nico basado en caracter√≠sticas del dispositivo
                const browserInfo = navigator.userAgent;
                const screen = `${window.screen.width}x${window.screen.height}`;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const timestamp = Date.now();
                
                // Crear hash simple
                deviceId = btoa(`${browserInfo}|${screen}|${timezone}|${timestamp}`).substring(0, 20);
                localStorage.setItem('deviceId', deviceId);
            }
            
            return deviceId;
        }

        // ‚úÖ NUEVO: Obtener IP aproximadamente (usando servicio externo)
        async function getDeviceIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json', { timeout: 3000 });
                const data = await response.json();
                return data.ip;
            } catch (e) {
                return 'N/A'; // Si falla, no es cr√≠tico
            }
        }

        // ‚úÖ NUEVO: Verificar si hay registros recientes del mismo device
        function checkRecentRegistrosSameDevice(deviceId) {
            const presencas = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const now = Date.now();
            const timeLimit = 5 * 60 * 1000; // 5 minutos
            
            const recentRegistros = presencas.filter(p => {
                if (!p.deviceId) return false;
                if (p.deviceId !== deviceId) return false;
                
                const registroTime = p.id; // El ID es el timestamp
                const timeDiff = now - registroTime;
                return timeDiff < timeLimit && timeDiff > 0;
            });
            
            return recentRegistros;
        }

        // ‚úÖ NUEVO: Mostrar alerta de registro reciente
        function showRecentDeviceAlert(registros) {
            if (registros.length === 0) return;
            
            const ultimoRegistro = registros[registros.length - 1];
            const timeDiff = Date.now() - ultimoRegistro.id;
            const minutos = Math.floor(timeDiff / 60000);
            
            const alertMsg = document.createElement('div');
            alertMsg.style.cssText = `
                background: #fff3cd;
                border: 2px solid #ff9800;
                border-radius: 6px;
                padding: 15px;
                margin-bottom: 20px;
                color: #856404;
                font-size: 14px;
            `;
            
            alertMsg.innerHTML = `
                <strong>‚ö†Ô∏è ALERTA: Registro Reciente del Mismo Dispositivo</strong><br>
                <small>
                    Este dispositivo registr√≥ una asistencia hace <strong>${minutos} minuto(s)</strong><br>
                    Empleado anterior: <strong>${ultimoRegistro.nomeFuncionario}</strong><br>
                    Hora: ${ultimoRegistro.hora}<br>
                    <br>
                    ¬øEst√° intentando registrar con el dispositivo de otro empleado?
                </small>
            `;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertMsg, mainContent.firstChild);
            
            // Auto-remover despu√©s de 10 segundos
            setTimeout(() => {
                if (alertMsg.parentNode) {
                    alertMsg.remove();
                }
            }, 10000);
        }

        // Inicializar Device ID
        const currentDeviceId = getDeviceId();
        let currentDeviceIP = 'Cargando...';
        getDeviceIP().then(ip => { 
            currentDeviceIP = ip;
            document.getElementById('ipInfo').textContent = ip;
        });

        // ‚úÖ Mostrar Device ID na tela
        document.getElementById('deviceInfo').textContent = currentDeviceId;

        // Configurar fecha y hora actual
        function updateDateTime() {
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('es-ES');
            const horaFormatada = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            dataRegistroInput.value = dataFormatada;
            document.getElementById('timeDisplay').textContent = `Hora: ${horaFormatada}`;
        }

        // Actualizar hora cada segundo
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Variables para reintentos de geolocalizaci√≥n
        let geoAttempt = 0;
        const maxGeoAttempts = 3;
        let geoTimeoutHandle = null;

        // Capturar Geolocalizaci√≥n con m√∫ltiples estrategias
        captureLocationBtn.addEventListener('click', (e) => {
            e.preventDefault();
            attemptGeoLocationAdvancedV5();
        });

        async function attemptGeoLocationAdvancedV5() {
            locationInfo.classList.add('loading');
            locationInfo.innerHTML = `üîÑ Intentando capturar ubicaci√≥n... Esto puede tardar 3-5 segundos`;

            // Primero, verificar permisos del navegador
            const hasPermission = await checkGeolocationPermission();
            
            if (!hasPermission) {
                locationInfo.classList.remove('loading');
                locationInfo.classList.add('error');
                locationInfo.innerHTML = `
                    ‚ö†Ô∏è <strong>Permiso de ubicaci√≥n denegado en navegador</strong><br>
                    <small style="display: block; margin-top: 5px; color: #d32f2f;">
                        El navegador RECHAZ√ì el acceso a la ubicaci√≥n.<br>
                        Intente: Recargar p√°gina (F5) y PERMITIR el acceso a ubicaci√≥n
                    </small>
                `;
                showManualLocationSection();
                addHelpDialog();
                // Continuar con IP fallback de todas formas
                setTimeout(() => attemptIPGeolocationMultiple(), 1000);
                return;
            }

            // Intentar m√∫ltiples m√©todos en PARALELO
            const results = await Promise.allSettled([
                attemptGPSLocationWithRetry(),
                attemptIPGeolocation1(),  // ipapi.co
                attemptIPGeolocation2(),  // geoip-db.com
                attemptIPGeolocation3(),  // ip-api.com
                attemptIPGeolocation4()   // freegeoip.app
            ]);

            // Procesar resultados - usar el primero que funcione
            for (let result of results) {
                if (result.status === 'fulfilled' && result.value) {
                    const { lat, lng, accuracy, method, info } = result.value;
                    
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        document.getElementById('accuracy').value = accuracy;

                        locationInfo.classList.remove('loading', 'error');
                        locationInfo.classList.add('success');
                        
                        let methodLabel = '';
                        let methodColor = '#4caf50';
                        
                        if (method === 'GPS') {
                            methodLabel = '‚úì GPS del dispositivo (muy preciso)';
                            methodColor = '#4caf50';
                        } else if (method === 'IP') {
                            methodLabel = `üì° Geolocalizaci√≥n por IP (${info})`;
                            methodColor = '#ff9800';
                        }
                        
                        locationInfo.innerHTML = `
                            <div style="color: ${methodColor}; font-weight: 600;">${methodLabel}</div>
                            Latitud: ${lat.toFixed(6)}<br>
                            Longitud: ${lng.toFixed(6)}<br>
                            Precisi√≥n: ¬±${accuracy.toFixed(1)} metros<br>
                            <small style="color: #666;">üìç <a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" style="color: #667eea;">Ver en Google Maps</a></small>
                        `;
                        document.getElementById('manualLocationSection').style.display = 'none';
                        document.getElementById('locationHelpSection').style.display = 'none';
                        return;
                    }
                }
            }

            // Si todos fallan, mostrar opci√≥n manual
            locationInfo.classList.remove('loading');
            showLocationError('No se pudo obtener ubicaci√≥n. Use la opci√≥n manual.');
            showManualLocationSection();
            addHelpDialog();
        }

        // Verificar permiso de geolocalizaci√≥n
        async function checkGeolocationPermission() {
            if (!navigator.geolocation) {
                return false;
            }
            
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    return permission.state !== 'denied';
                }
            } catch (e) {
                // Si no soporta query, asumir que funciona
                return true;
            }
            return true;
        }

        // M√©todo 1: GPS con reintentos internos
        function attemptGPSLocationWithRetry() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve(null);
                    return;
                }

                let gpsAttempts = 0;
                
                function tryGPS() {
                    gpsAttempts++;
                    
                    const timeout = setTimeout(() => {
                        if (gpsAttempts < 3) {
                            tryGPS(); // Reintentar
                        } else {
                            resolve(null);
                        }
                    }, 6000);

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(timeout);
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy || 50;

                            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                                resolve({ lat, lng, accuracy, method: 'GPS', info: '' });
                            } else if (gpsAttempts < 3) {
                                tryGPS();
                            } else {
                                resolve(null);
                            }
                        },
                        (error) => {
                            clearTimeout(timeout);
                            // Reintentar si es timeout
                            if (error.code === error.TIMEOUT && gpsAttempts < 3) {
                                tryGPS();
                            } else {
                                resolve(null);
                            }
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                }
                
                tryGPS();
            });
        }

        // M√©todo 2: IP por ipapi.co
        async function attemptIPGeolocation1() {
            try {
                const response = await Promise.race([
                    fetch('https://ipapi.co/json/'),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                ]);
                
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    return {
                        lat: data.latitude,
                        lng: data.longitude,
                        accuracy: 5000,
                        method: 'IP',
                        info: `${data.city}, ${data.country_name}`
                    };
                }
            } catch (error) {
                // Fall√≥
            }
            return null;
        }

        // M√©todo 3: IP por geoip-db.com
        async function attemptIPGeolocation2() {
            try {
                const response = await Promise.race([
                    fetch('https://geoip-db.com/json/'),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                ]);
                
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    return {
                        lat: data.latitude,
                        lng: data.longitude,
                        accuracy: 5000,
                        method: 'IP',
                        info: `${data.city || 'Ubicaci√≥n'}`
                    };
                }
            } catch (error) {
                // Fall√≥
            }
            return null;
        }

        // M√©todo 4: IP por ip-api.com
        async function attemptIPGeolocation3() {
            try {
                const response = await Promise.race([
                    fetch('https://ip-api.com/json/?fields=lat,lon,city,country'),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                ]);
                
                const data = await response.json();
                
                if (data.lat && data.lon) {
                    return {
                        lat: data.lat,
                        lng: data.lon,
                        accuracy: 5000,
                        method: 'IP',
                        info: `${data.city || 'Ubicaci√≥n'}, ${data.country}`
                    };
                }
            } catch (error) {
                // Fall√≥
            }
            return null;
        }

        // M√©todo 5: IP por freegeoip.app
        async function attemptIPGeolocation4() {
            try {
                const response = await Promise.race([
                    fetch('https://freegeoip.app/json/'),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                ]);
                
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    return {
                        lat: data.latitude,
                        lng: data.longitude,
                        accuracy: 5000,
                        method: 'IP',
                        info: `${data.city || 'Ubicaci√≥n'}, ${data.country_name}`
                    };
                }
            } catch (error) {
                // Fall√≥
            }
            return null;
        }

        // Alternativa si todas las APIs fallan
        async function attemptIPGeolocationMultiple() {
            const results = await Promise.allSettled([
                attemptIPGeolocation1(),
                attemptIPGeolocation2(),
                attemptIPGeolocation3(),
                attemptIPGeolocation4()
            ]);

            for (let result of results) {
                if (result.status === 'fulfilled' && result.value) {
                    const { lat, lng } = result.value;
                    if (lat && lng) {
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        document.getElementById('accuracy').value = '5000';

                        locationInfo.classList.remove('loading', 'error');
                        locationInfo.classList.add('success');
                        locationInfo.innerHTML = `
                            üì° Ubicaci√≥n obtenida por IP (aproximada)<br>
                            Latitud: ${lat.toFixed(6)}<br>
                            Longitud: ${lng.toFixed(6)}<br>
                            <small style="color: #ff9800;">Nota: No es GPS preciso, sino ubicaci√≥n aproximada</small>
                        `;
                        return;
                    }
                }
            }
        }

        function addHelpDialog() {
            const helpSection = document.getElementById('locationHelpSection');
            if (helpSection && helpSection.style.display === 'none') {
                helpSection.style.display = 'block';
            }
        }

        function showLocationError(msg) {
            locationInfo.classList.add('error');
            locationInfo.classList.remove('loading', 'success');
            locationInfo.innerHTML = `‚úó ${msg}`;
            document.getElementById('locationHelpSection').style.display = 'block';
        }

        function showManualLocationSection() {
            document.getElementById('manualLocationSection').style.display = 'block';
        }

        // Guardar ubicaci√≥n manual
        document.getElementById('saveManualLocation').addEventListener('click', (e) => {
            e.preventDefault();
            
            const lat = document.getElementById('latitudeManual').value.trim();
            const lng = document.getElementById('longitudeManual').value.trim();
            
            if (!lat || !lng) {
                showError('Por favor, ingrese latitud y longitud');
                return;
            }
            
            const latNum = parseFloat(lat);
            const lngNum = parseFloat(lng);
            
            if (isNaN(latNum) || isNaN(lngNum)) {
                showError('Latitud y longitud deben ser n√∫meros v√°lidos');
                return;
            }
            
            if (latNum < -90 || latNum > 90) {
                showError('Latitud debe estar entre -90 y 90');
                return;
            }
            
            if (lngNum < -180 || lngNum > 180) {
                showError('Longitud debe estar entre -180 y 180');
                return;
            }
            
            document.getElementById('latitude').value = latNum;
            document.getElementById('longitude').value = lngNum;
            document.getElementById('accuracy').value = '0';
            
            locationInfo.classList.remove('error', 'loading');
            locationInfo.classList.add('success');
            locationInfo.innerHTML = `
                ‚úì Ubicaci√≥n guardada manualmente<br>
                Latitud: ${latNum.toFixed(6)}<br>
                Longitud: ${lngNum.toFixed(6)}<br>
                <small style="color: #999;">Modo manual</small>
            `;
            
            document.getElementById('manualLocationSection').style.display = 'none';
        });

        // Capturar Foto
        fotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    fotoBase64 = event.target.result;
                    photoPreview.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                            <img src="${fotoBase64}" alt="Pr√©via da foto">
                            <button type="button" class="photo-remove" onclick="removerFoto()">&times;</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        function removerFoto() {
            fotoBase64 = null;
            fotoInput.value = '';
            photoPreview.innerHTML = '';
        }

        window.removerFoto = removerFoto;

        // Validar si es del d√≠a actual
        function validarDataAtual() {
            const dataInput = dataRegistroInput.value;
            const hoje = new Date().toLocaleDateString('es-ES');
            
            if (dataInput !== hoje) {
                dateWarning.classList.add('active');
                return false;
            } else {
                dateWarning.classList.remove('active');
                return true;
            }
        }

        // Guardar asistencia
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!validarDataAtual()) {
                showError('No se permiten registrar asistencias en fechas anteriores. Use solo la fecha de hoy.');
                return;
            }

            if (!fotoBase64) {
                showError('Por favor, capture una foto antes de registrar.');
                return;
            }

            if (!document.getElementById('latitude').value) {
                showError('Por favor, capture la ubicaci√≥n antes de registrar.');
                return;
            }

            const presenca = {
                id: Date.now(),
                data: dataRegistroInput.value,
                hora: new Date().toLocaleTimeString('es-ES'),
                nomeFuncionario: document.getElementById('nomeFuncionario').value,
                cedula: document.getElementById('cedula').value,
                cargo: document.getElementById('cargo').value,
                obra: document.getElementById('obra').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                accuracy: document.getElementById('accuracy').value,
                tipoRegistro: document.getElementById('tipoRegistro').value,
                observacoes: document.getElementById('observacoes').value,
                foto: fotoBase64,
                deviceId: currentDeviceId,
                deviceIP: currentDeviceIP
            };

            // ‚úÖ NUEVO: Verificar registros recientes del mismo dispositivo
            const registrosRecientes = checkRecentRegistrosSameDevice(currentDeviceId);
            if (registrosRecientes.length > 0) {
                showRecentDeviceAlert(registrosRecientes);
            }

            // Guardar en localStorage
            let presencas = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            presencas.push(presenca);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(presencas));

            // Mostrar mensaje de √©xito
            showSuccess();

            // Limpiar formulario
            setTimeout(() => {
                form.reset();
                removerFoto();
                updateDateTime();
                document.getElementById('locationInfo').classList.remove('success');
                document.getElementById('locationInfo').classList.remove('error');
                document.getElementById('locationInfo').textContent = 'Ubicaci√≥n no capturada';
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                document.getElementById('accuracy').value = '';
                successMessage.classList.remove('active');
            }, 2000);
        });

        function showSuccess() {
            successMessage.classList.add('active');
            setTimeout(() => {
                successMessage.classList.remove('active');
            }, 5000);
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorMessage.classList.add('active');
            setTimeout(() => {
                errorMessage.classList.remove('active');
            }, 5000);
        }

        // Limpiar formulario
        clearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            form.reset();
            removerFoto();
            updateDateTime();
            document.getElementById('locationInfo').classList.remove('success', 'error');
            document.getElementById('locationInfo').textContent = 'Ubicaci√≥n no capturada';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('accuracy').value = '';
        });

        // Visualizar Reporte
        viewReportBtn.addEventListener('click', () => {
            const hoje = new Date().toLocaleDateString('es-ES');
            let presencas = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            presencas = presencas.filter(p => p.data === hoje);
            reportDataGlobal = presencas;

            if (presencas.length === 0) {
                reportContent.innerHTML = `
                    <div class="empty-report">
                        <p>üì≠ Ning√∫n registro de asistencia para hoy</p>
                    </div>
                `;
            } else {
                let html = `
                    <p style="margin-bottom: 20px; color: #666; font-size: 14px;">
                        <strong>Fecha:</strong> ${hoje} | 
                        <strong>Total de Registros:</strong> ${presencas.length}
                    </p>
                    <div style="overflow-x: auto;">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Empleado</th>
                                    <th>Cargo</th>
                                    <th>Tipo</th>
                                    <th>Obra</th>
                                    <th>Foto</th>
                                    <th>Ubicaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                presencas.forEach(p => {
                    html += `
                        <tr>
                            <td>${p.hora}</td>
                            <td>${p.nomeFuncionario}</td>
                            <td>${p.cargo}</td>
                            <td><strong>${p.tipoRegistro}</strong></td>
                            <td>${p.obra}</td>
                            <td><img src="${p.foto}" alt="Foto" class="report-photo" onclick="abrirFotoModal('${p.foto}')"></td>
                            <td>
                                <a href="https://maps.google.com/?q=${p.latitude},${p.longitude}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 12px;">
                                    üìç Ver en mapa
                                </a>
                                <br><small style="color: #999;">¬±${p.accuracy}m</small>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                reportContent.innerHTML = html;
            }

            reportModal.classList.add('active');
        });

        function abrirFotoModal(foto) {
            photoModalImage.src = foto;
            photoModal.classList.add('active');
        }

        window.abrirFotoModal = abrirFotoModal;

        // Cerrar modales
        closeReportBtn.addEventListener('click', () => {
            reportModal.classList.remove('active');
        });

        photoModal.addEventListener('click', () => {
            photoModal.classList.remove('active');
        });

        closeWhatsappBtn.addEventListener('click', () => {
            whatsappModal.classList.remove('active');
        });

        // Generar PDF
        function generarPDF(callback) {
            const hoje = new Date().toLocaleDateString('es-ES');
            let presencas = reportDataGlobal;

            if (presencas.length === 0) {
                alert('No hay registros para exportar');
                return;
            }

            try {
                // Crear ventana nueva para imprimir
                const printWindow = window.open('', '_blank', 'width=1000,height=700');
                
                // HTML completo para el PDF
                let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte de Asistencia</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, sans-serif; padding: 20px; background: white; color: #333; }
                        h2 { text-align: center; color: #333; margin: 10px 0; font-size: 18px; }
                        h3 { text-align: center; color: #333; margin: 20px 0 10px 0; font-size: 14px; }
                        h4 { color: #667eea; margin: 10px 0; font-size: 13px; }
                        p { text-align: center; color: #666; margin: 5px 0; font-size: 12px; }
                        hr { border: none; border-top: 2px solid #667eea; margin: 20px 0; }
                        .info { font-size: 12px; margin: 10px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px; }
                        th { background-color: #667eea; color: white; border: 1px solid #999; padding: 8px; text-align: left; font-weight: bold; }
                        td { border: 1px solid #ddd; padding: 8px; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        tr:nth-child(odd) { background-color: #ffffff; }
                        .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #999; }
                        .no-print { display: none; }
                        img { max-width: 100%; height: auto; }
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none !important; }
                            button { display: none !important; }
                            h3 { page-break-before: always; }
                        }
                    </style>
                </head>
                <body>
                    <h2>REPORTE DE ASISTENCIA EN OBRA</h2>
                    <p>Electrogrupo S.A.C.I.</p>
                    <hr>
                    <div class="info"><strong>Fecha:</strong> ${hoje}</div>
                    <div class="info"><strong>Total de Registros:</strong> ${presencas.length}</div>
                    <hr>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Empleado</th>
                                <th>C√©dula</th>
                                <th>Cargo</th>
                                <th>Tipo</th>
                                <th>Obra</th>
                                <th>Ubicaci√≥n</th>
                                <th>Precisi√≥n</th>
                                <th>Device ID</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // Agregar filas de datos
                presencas.forEach((p) => {
                    htmlContent += `
                        <tr>
                            <td>${p.data || 'N/A'}</td>
                            <td>${p.hora || 'N/A'}</td>
                            <td>${p.nomeFuncionario || 'N/A'}</td>
                            <td>${p.cedula || 'N/A'}</td>
                            <td>${p.cargo || 'N/A'}</td>
                            <td>${p.tipoRegistro || 'N/A'}</td>
                            <td>${p.obra || 'N/A'}</td>
                            <td style="font-size: 9px;">${p.latitude ? p.latitude.substring(0,8) : 'N/A'}, ${p.longitude ? p.longitude.substring(0,8) : 'N/A'}</td>
                            <td>¬±${p.accuracy || 'N/A'}m</td>
                            <td style="font-size: 8px; font-family: monospace;">${p.deviceId || 'N/A'}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                        </tbody>
                    </table>
                    
                    <hr>
                    <h3 style="margin-top: 30px; color: #333;">Detalle de Registros con Fotos y Observaciones</h3>
                    <hr>
                `;

                // Agregar detalle con fotos y observaciones
                presencas.forEach((p, index) => {
                    htmlContent += `
                    <div style="margin-bottom: 30px; page-break-inside: avoid; border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Registro #${index + 1} - ${p.nomeFuncionario}</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Datos -->
                            <div>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Fecha:</strong> ${p.data || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Hora:</strong> ${p.hora || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Empleado:</strong> ${p.nomeFuncionario || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>C√©dula:</strong> ${p.cedula || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Cargo:</strong> ${p.cargo || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Tipo:</strong> ${p.tipoRegistro || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Obra:</strong> ${p.obra || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Ubicaci√≥n:</strong> ${p.latitude ? p.latitude.substring(0,8) : 'N/A'}, ${p.longitude ? p.longitude.substring(0,8) : 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 11px;"><strong>Precisi√≥n GPS:</strong> ¬±${p.accuracy || 'N/A'}m</p>
                                <p style="margin: 5px 0; font-size: 10px; font-family: monospace; background: #f5f5f5; padding: 3px 5px; border-radius: 3px;"><strong>Device ID:</strong> ${p.deviceId || 'N/A'}</p>
                                <p style="margin: 5px 0; font-size: 10px;"><strong>IP Address:</strong> ${p.deviceIP || 'N/A'}</p>
                            </div>
                            
                            <!-- Foto -->
                            <div style="text-align: center;">
                                ${p.foto ? `
                                    <img src="${p.foto}" style="max-width: 100%; max-height: 200px; border: 1px solid #ddd; border-radius: 4px; display: block; margin: 0 auto;">
                                ` : `
                                    <div style="width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; border-radius: 4px; color: #999;">
                                        Sin foto
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Observaciones -->
                        ${p.observacoes ? `
                            <div style="margin-top: 15px; padding: 10px; background: #f9f9f9; border-left: 4px solid #667eea; border-radius: 4px;">
                                <p style="margin: 0; font-size: 11px;"><strong>Observaciones:</strong></p>
                                <p style="margin: 5px 0 0 0; font-size: 11px; color: #555;">${p.observacoes}</p>
                            </div>
                        ` : ''}
                    </div>
                    `;
                });

                htmlContent += `
                    <div class="footer">
                        <p>Reporte generado autom√°ticamente - ${new Date().toLocaleString('es-ES')}</p>
                    </div>
                </body>
                </html>
                `;

                // Escribir el contenido en la nueva ventana
                printWindow.document.write(htmlContent);
                printWindow.document.close();

                // Esperar a que la ventana est√© lista y luego imprimir
                setTimeout(function() {
                    printWindow.print();
                }, 500);

                if (callback) callback();
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('Error al generar PDF. Intente nuevamente.');
            }
        }

        // Exportar a PDF
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            if (reportDataGlobal.length === 0) {
                alert('No hay registros para exportar');
                return;
            }
            generarPDF();
        });

        // Exportar a CSV
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            const hoje = new Date().toLocaleDateString('es-ES');
            let presencas = reportDataGlobal;

            if (presencas.length === 0) {
                alert('No hay registros para exportar');
                return;
            }

            // Cabe√ßalho do CSV com todas as colunas
            let csv = 'Fecha,Hora,Empleado,Cedula,Cargo,Tipo,Obra,Latitud,Longitud,Precisi√≥n,Observaciones\n';

            presencas.forEach(p => {
                const obs = (p.observacoes || '').replace(/,/g, ';').replace(/"/g, '""');
                const row = [
                    p.data || '',
                    p.hora || '',
                    p.nomeFuncionario || '',
                    p.cedula || '',
                    p.cargo || '',
                    p.tipoRegistro || '',
                    p.obra || '',
                    p.latitude || '',
                    p.longitude || '',
                    p.accuracy || '',
                    obs
                ];
                // Envolver em aspas e escapar aspas internas
                csv += row.map(cell => `"${String(cell)}"`).join(',') + '\n';
            });

            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
            element.setAttribute('download', `reporte_asistencia_${hoje.replace(/\//g, '-')}.csv`);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        });

        // Mostrar modal de WhatsApp
        exportWhatsappBtn.addEventListener('click', () => {
            if (reportDataGlobal.length === 0) {
                alert('No hay registros para enviar');
                return;
            }
            whatsappMessage.style.display = 'none';
            whatsappPhoneInput.value = '';
            whatsappModal.classList.add('active');
        });

        // Enviar PDF por WhatsApp
        sendWhatsappPdfBtn.addEventListener('click', () => {
            const phoneNumber = whatsappPhoneInput.value.trim();
            
            if (!phoneNumber) {
                whatsappMessage.style.display = 'block';
                whatsappMessage.textContent = '‚ö†Ô∏è Por favor, ingrese un n√∫mero de tel√©fono v√°lido';
                return;
            }

            // Limpiar n√∫mero: solo n√∫meros y +
            const cleanPhone = phoneNumber.replace(/\D/g, '').replace(/^\+/, '') || phoneNumber.replace(/[^0-9+]/g, '');
            
            if (!cleanPhone || cleanPhone.length < 10) {
                whatsappMessage.style.display = 'block';
                whatsappMessage.textContent = '‚ö†Ô∏è El n√∫mero de tel√©fono no parece ser v√°lido. Intente nuevamente.';
                return;
            }

            // Generar PDF y obtener la URL
            generarPDF(() => {
                const hoje = new Date().toLocaleDateString('es-ES');
                const mensaje = encodeURIComponent(`Reporte de Asistencia en Obra - ${hoje}`);
                const phoneParam = phoneNumber.startsWith('+') ? phoneNumber.replace(/\D/g, '') : cleanPhone;
                const whatsappUrl = `https://wa.me/${phoneParam}?text=${mensaje}`;
                
                // Mostrar mensaje de √©xito
                whatsappMessage.style.display = 'block';
                whatsappMessage.style.background = '#e8f5e9';
                whatsappMessage.style.borderLeftColor = '#4caf50';
                whatsappMessage.style.color = '#2e7d32';
                whatsappMessage.innerHTML = `
                    ‚úì PDF generado. <a href="${whatsappUrl}" target="_blank" style="color: #2e7d32; font-weight: bold; text-decoration: underline;">
                    Abre WhatsApp para enviar</a>
                `;

                // Alternativamente, abre WhatsApp directamente
                setTimeout(() => {
                    window.open(whatsappUrl, '_blank');
                }, 500);
            });
        });

        // Validar tel√©fono en tiempo real
        whatsappPhoneInput.addEventListener('input', () => {
            whatsappMessage.style.display = 'none';
        });
    </script>
</body>
</html>