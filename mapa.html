<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Registros - Electrogrupo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 20px; }
        .header-links { display: flex; gap: 10px; }
        .header-links a {
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.3s;
        }
        .header-links a:hover { background: rgba(255,255,255,0.3); }
        
        .filters {
            background: #f5f5f5;
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 12px; font-weight: 600; color: #555; }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #43a047; }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-left: auto;
            font-size: 13px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .stat-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .stat-dot.entrada { background: #4caf50; }
        .stat-dot.salida { background: #f44336; }
        .stat-dot.pausa { background: #ff9800; }
        .stat-dot.retorno { background: #2196f3; }
        
        #map {
            height: calc(100vh - 140px);
            width: 100%;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 50px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        .loading.hidden { display: none; }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .popup-content { min-width: 250px; }
        .popup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .popup-type {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .popup-type.entrada { background: #4caf50; }
        .popup-type.salida { background: #f44336; }
        .popup-type.pausa { background: #ff9800; }
        .popup-type.retorno { background: #2196f3; }
        
        .popup-name { font-size: 16px; font-weight: 600; color: #333; }
        .popup-info { font-size: 13px; color: #666; margin-bottom: 8px; }
        .popup-info strong { color: #333; }
        .popup-photo {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
        }
        .popup-photo:hover { opacity: 0.9; }
        
        .no-data {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        .no-data.hidden { display: none; }
        .no-data h2 { color: #666; margin-bottom: 10px; }
        .no-data p { color: #999; }
        
        /* Modal de foto ampliada */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .photo-modal.active { display: flex; }
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
        
        /* Legenda do mapa */
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .legend h4 { margin-bottom: 10px; color: #333; }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .header { padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .filters { padding: 10px 15px; }
            .filter-group select, .filter-group input { min-width: 120px; }
            .stats { display: none; }
            #map { height: calc(100vh - 180px); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Mapa de Registros - Electrogrupo</h1>
        <div class="header-links">
            <a href="index.html">üìù Registrar Asistencia</a>
            <a href="relatorio.html">üìä Relat√≥rios RH</a>
            <a href="https://docs.google.com/spreadsheets/d/1O5e46G2obLozmqTtQOJir6iO_Hu7fE-pDY-iKy-Tmxw/edit" target="_blank">üìä Ver Planilla</a>
        </div>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label>üìÖ Fecha</label>
            <input type="date" id="filterDate">
        </div>
        <div class="filter-group">
            <label>üë§ Funcionario</label>
            <select id="filterFuncionario">
                <option value="">Todos</option>
            </select>
        </div>
        <div class="filter-group">
            <label>üìã Tipo</label>
            <select id="filterTipo">
                <option value="">Todos</option>
                <option value="Entrada">Entrada</option>
                <option value="Salida">Salida</option>
                <option value="Pausa">Pausa</option>
                <option value="Retorno">Retorno</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="aplicarFiltros()">üîç Filtrar</button>
        <button class="btn btn-success" onclick="cargarDatos()">üîÑ Actualizar</button>
        
        <div class="stats" id="stats">
            <div class="stat-item"><div class="stat-dot entrada"></div> <span id="countEntrada">0</span> Entradas</div>
            <div class="stat-item"><div class="stat-dot salida"></div> <span id="countSalida">0</span> Salidas</div>
            <div class="stat-item"><div class="stat-dot pausa"></div> <span id="countPausa">0</span> Pausas</div>
            <div class="stat-item"><div class="stat-dot retorno"></div> <span id="countRetorno">0</span> Retornos</div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>Cargando registros...</p>
    </div>
    
    <div class="no-data hidden" id="noData">
        <h2>üì≠ Sin registros</h2>
        <p>No se encontraron registros con los filtros seleccionados.</p>
    </div>
    
    <div class="photo-modal" id="photoModal">
        <span class="photo-modal-close" onclick="cerrarFoto()">&times;</span>
        <img id="photoModalImg" src="" alt="Foto ampliada">
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytkz2c_j-vDVUdyts5iqxeahKcHFN2HTvMpDj8VyF-UXGM4nbOBtXB9Xr0TnxEXj7F/exec';
        
        var map;
        var markers = [];
        var allData = [];
        
        // Colores por tipo
        var colores = {
            'Entrada': '#4caf50',
            'Salida': '#f44336',
            'Pausa': '#ff9800',
            'Retorno': '#2196f3'
        };
        
        // ============================================
        // INICIALIZACI√ìN DEL MAPA
        // ============================================
        function initMap() {
            // Centro en Paraguay
            map = L.map('map').setView([-25.2637, -57.5759], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Agregar leyenda
            var legend = L.control({ position: 'bottomright' });
            legend.onAdd = function(map) {
                var div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<h4>Tipo de Registro</h4>' +
                    '<div class="legend-item"><div class="legend-color" style="background:#4caf50;"></div> Entrada</div>' +
                    '<div class="legend-item"><div class="legend-color" style="background:#f44336;"></div> Salida</div>' +
                    '<div class="legend-item"><div class="legend-color" style="background:#ff9800;"></div> Pausa</div>' +
                    '<div class="legend-item"><div class="legend-color" style="background:#2196f3;"></div> Retorno</div>';
                return div;
            };
            legend.addTo(map);
            
            // Establecer fecha de hoy por defecto - comentado para mostrar todos
            // var today = new Date().toISOString().split('T')[0];
            // document.getElementById('filterDate').value = today;
            
            // Cargar datos
            cargarDatos();
        }
        
        // ============================================
        // CARGAR DATOS DE GOOGLE SHEETS
        // ============================================
        function cargarDatos() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('noData').classList.add('hidden');
            
            fetch(GOOGLE_SCRIPT_URL)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    console.log('Datos recibidos:', data);
                    allData = data;
                    
                    // Llenar filtro de funcionarios
                    llenarFiltroFuncionarios(data);
                    
                    // Aplicar filtros y mostrar
                    aplicarFiltros();
                    
                    document.getElementById('loading').classList.add('hidden');
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    document.getElementById('loading').classList.add('hidden');
                    alert('Error al cargar datos: ' + error.message);
                });
        }
        
        // ============================================
        // LLENAR FILTRO DE FUNCIONARIOS
        // ============================================
        function llenarFiltroFuncionarios(data) {
            var funcionarios = [];
            data.forEach(function(registro) {
                var nombre = registro.Nombre || registro.nomeFuncionario;
                if (nombre && funcionarios.indexOf(nombre) === -1) {
                    funcionarios.push(nombre);
                }
            });
            
            funcionarios.sort();
            
            var select = document.getElementById('filterFuncionario');
            select.innerHTML = '<option value="">Todos</option>';
            funcionarios.forEach(function(nombre) {
                var option = document.createElement('option');
                option.value = nombre;
                option.textContent = nombre;
                select.appendChild(option);
            });
        }
        
        // ============================================
        // APLICAR FILTROS
        // ============================================
        function aplicarFiltros() {
            var fechaFiltro = document.getElementById('filterDate').value;
            var funcionarioFiltro = document.getElementById('filterFuncionario').value;
            var tipoFiltro = document.getElementById('filterTipo').value;
            
            // Convertir fecha del filtro al formato de la planilla (DD/MM/YYYY)
            var fechaFormateada = '';
            if (fechaFiltro) {
                var partes = fechaFiltro.split('-');
                fechaFormateada = partes[2] + '/' + partes[1] + '/' + partes[0];
            }
            
            console.log('Filtro fecha:', fechaFormateada);
            
            var datosFiltrados = allData.filter(function(registro) {
                var fecha = registro.Fecha || registro.data || '';
                var nombre = registro.Nombre || registro.nomeFuncionario || '';
                var tipo = registro.Tipo || registro.tipoRegistro || '';
                
                // Filtrar tests
                if (nombre === '** PRUEBA DE CONEXI√ìN **' || fecha === 'TEST') {
                    return false;
                }
                
                // Filtrar por fecha - comparar solo si hay filtro
                if (fechaFormateada && fecha) {
                    if (fecha !== fechaFormateada) {
                        return false;
                    }
                }
                
                // Filtrar por funcionario
                if (funcionarioFiltro && nombre !== funcionarioFiltro) {
                    return false;
                }
                
                // Filtrar por tipo
                if (tipoFiltro && tipo !== tipoFiltro) {
                    return false;
                }
                
                return true;
            });
            
            mostrarEnMapa(datosFiltrados);
            actualizarEstadisticas(datosFiltrados);
        }
        
        // ============================================
        // MOSTRAR MARCADORES EN EL MAPA
        // ============================================
        function mostrarEnMapa(datos) {
            // Limpiar marcadores anteriores
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            markers = [];
            
            if (datos.length === 0) {
                document.getElementById('noData').classList.remove('hidden');
                return;
            }
            
            document.getElementById('noData').classList.add('hidden');
            
            var bounds = [];
            
            datos.forEach(function(registro) {
                var latRaw = registro.Latitud || registro.latitude || '';
                var lngRaw = registro.Longitud || registro.longitude || '';
                
                // Converter para n√∫mero (pode vir como string)
                var lat = parseFloat(String(latRaw).replace(',', '.'));
                var lng = parseFloat(String(lngRaw).replace(',', '.'));
                
                console.log('Coordenadas:', lat, lng);
                
                if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                    console.log('Coordenadas inv√°lidas, pulando');
                    return;
                }
                
                var tipo = registro.Tipo || registro.tipoRegistro || 'Entrada';
                var color = colores[tipo] || '#667eea';
                
                var nombre = registro.Nombre || registro.nomeFuncionario || 'Sin nombre';
                var fecha = registro.Fecha || registro.data || '';
                
                // Normalizar hora - agora vem como texto direto
                var hora = registro.Hora || registro.hora || '';
                
                var cedula = registro.Cedula || registro.cedula || '';
                var cargo = registro.Cargo || registro.cargo || '';
                var obra = registro.Obra || registro.obra || '';
                var observaciones = registro.Observaciones || registro.observacoes || '';
                var foto = registro.Foto || registro.foto || '';
                
                // Crear icono personalizado
                var icon = L.divIcon({
                    html: '<div style="background-color:' + color + '; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">' + 
                          (tipo === 'Entrada' ? '‚Üí' : tipo === 'Salida' ? '‚Üê' : tipo === 'Pausa' ? '‚è∏' : '‚ñ∂') + '</div>',
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15],
                    popupAnchor: [0, -15]
                });
                
                var marker = L.marker([lat, lng], { icon: icon }).addTo(map);
                
                // Contenido del popup
                var tipoClass = tipo.toLowerCase().replace(' de pausa', '');
                var popupContent = '<div class="popup-content">' +
                    '<div class="popup-header">' +
                    '<span class="popup-type ' + tipoClass + '">' + tipo + '</span>' +
                    '<span class="popup-name">' + nombre + '</span>' +
                    '</div>' +
                    '<div class="popup-info"><strong>üìÖ Fecha:</strong> ' + fecha + '</div>' +
                    '<div class="popup-info"><strong>üïê Hora:</strong> ' + hora + '</div>' +
                    '<div class="popup-info"><strong>ü™™ C√©dula:</strong> ' + cedula + '</div>' +
                    '<div class="popup-info"><strong>üë∑ Cargo:</strong> ' + cargo + '</div>' +
                    '<div class="popup-info"><strong>üèóÔ∏è Obra:</strong> ' + obra + '</div>';
                
                if (observaciones) {
                    popupContent += '<div class="popup-info"><strong>üìù Obs:</strong> ' + observaciones + '</div>';
                }
                
                if (foto && foto.startsWith('data:image')) {
                    popupContent += '<img src="' + foto + '" class="popup-photo" onclick="ampliarFoto(\'' + encodeURIComponent(foto) + '\')">';
                }
                
                popupContent += '</div>';
                
                marker.bindPopup(popupContent, { maxWidth: 300 });
                
                markers.push(marker);
                bounds.push([lat, lng]);
            });
            
            // Ajustar zoom para mostrar todos los marcadores
            if (bounds.length > 0) {
                if (bounds.length === 1) {
                    map.setView(bounds[0], 15);
                } else {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // ============================================
        // ACTUALIZAR ESTAD√çSTICAS
        // ============================================
        function actualizarEstadisticas(datos) {
            var contadores = {
                'Entrada': 0,
                'Salida': 0,
                'Pausa': 0,
                'Retorno': 0
            };
            
            datos.forEach(function(registro) {
                var tipo = registro.Tipo || registro.tipoRegistro || '';
                if (tipo === 'Retorno de Pausa') tipo = 'Retorno';
                if (contadores.hasOwnProperty(tipo)) {
                    contadores[tipo]++;
                }
            });
            
            document.getElementById('countEntrada').textContent = contadores['Entrada'];
            document.getElementById('countSalida').textContent = contadores['Salida'];
            document.getElementById('countPausa').textContent = contadores['Pausa'];
            document.getElementById('countRetorno').textContent = contadores['Retorno'];
        }
        
        // ============================================
        // FUNCIONES DE FOTO
        // ============================================
        function ampliarFoto(fotoEncoded) {
            var foto = decodeURIComponent(fotoEncoded);
            document.getElementById('photoModalImg').src = foto;
            document.getElementById('photoModal').classList.add('active');
        }
        
        function cerrarFoto() {
            document.getElementById('photoModal').classList.remove('active');
        }
        
        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarFoto();
            }
        });
        
        // ============================================
        // INICIAR
        // ============================================
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
